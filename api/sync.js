const db = require('./database')
const Logger = require('./logger')
const logger = new Logger('app')
const fm = require('./fileManager')
const DEFAULT_BOARDS = require('../app').DEFAULT_BOARDS

const tables = {
    BOARD : 'board'
}
const schema = {
    BOARD : 'board',
    THREAD_REPLY : 'thread_reply'
}

exports.schema = schema
exports.tables = tables

async function checkTableExists(table) {
    try {
        let q = await db.query(`
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE  table_schema = 'public'
                AND    table_name   = '${table}'
            );
        `)
        return (q[0] && q[0].exists === true)

    } catch (err) { 
        logger.error('Error after check table')
    }
    return false
}

;(async() => {
    if (await checkTableExists(tables.BOARD) === false) {
        try {
            await db.query(`
                CREATE TABLE ${tables.BOARD} (
                    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    name varchar(200) NOT NULL,
                    path varchar(100) NOT NULL,
                    date timestamp DEFAULT current_timestamp
                );
            `)
            logger.ok('Table: board, successful created!')
        } catch (err) {
            logger.fatal('Error after create \'board\' table', err)
        }

        try {
            await db.query(`CREATE SCHEMA IF NOT EXISTS ${schema.BOARD}`)
            await db.query(`CREATE SCHEMA IF NOT EXISTS ${schema.THREAD_REPLY}`)

        } catch (err) {
            logger.fatal('Error after create boards schema')
        }
    }

    try {
        for (b of DEFAULT_BOARDS) {
            let q = await db.query(`SELECT path FROM ${tables.BOARD} WHERE path = $1`, [b.path])
            if (!q[0] || !q[0].path) {
                await db.query(`INSERT INTO ${tables.BOARD}(name, path) VALUES ($1, $2)`, [b.name, b.path])
                await db.query(`
                    CREATE TABLE ${schema.BOARD}.${b.path} (
                        id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                        title varchar(200) NOT NULL,
                        username varchar(200) DEFAULT('Anonymous'),
                        content text DEFAULT(''),
                        file_info text DEFAULT(''),
                        updated varchar(200) DEFAULT(''),
                        date timestamp DEFAULT current_timestamp
                    );
                `)
                await db.query(`
                    CREATE TABLE ${schema.THREAD_REPLY}.${b.path} (
                        id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                        thid int NOT NULL,
                        username varchar(200) DEFAULT('Anonymous'),
                        content text DEFAULT(''),
                        file_info text DEFAULT(''),
                        date timestamp DEFAULT current_timestamp
                    );
                `)
                logger.ok(`* New board created: ${b.name} with path: ${b.path}`)
            }
        }
    } catch (err) {
        logger.fatal('Error after insert default boards', err)
    }

    fm.updateFileSystem(tables.BOARD)
})()